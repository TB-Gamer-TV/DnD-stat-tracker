<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Utility Hub</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles to ensure Inter font and smooth transitions */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top to allow scrolling for longer content */
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
        }
        .main-container {
            background-color: #2d3748; /* Slightly lighter dark background for the main card */
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            max-width: 900px; /* Wider to accommodate both apps */
            width: 100%;
            padding: 2.5rem;
            text-align: center;
            border: 1px solid #4a5568; /* Subtle border */
            margin-top: 2rem; /* Add some top margin */
            margin-bottom: 2rem; /* Add some bottom margin */
        }

        /* General button style */
        .btn {
            background-image: linear-gradient(to right, #63b3ed, #4299e1); /* Blue gradient */
            color: white;
            padding: 0.8rem 2rem;
            border-radius: 0.75rem; /* Rounded button */
            font-weight: bold;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            cursor: pointer;
            outline: none;
        }
        .btn:hover {
            background-image: linear-gradient(to right, #4299e1, #3182ce);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Specific button overrides for Stat Tracker (green/red/purple) */
        .btn-green {
            background-image: linear-gradient(to right, #48bb78, #38a169);
        }
        .btn-green:hover {
            background-image: linear-gradient(to right, #38a169, #2f855a);
        }
        .btn-red {
            background-image: linear-gradient(to right, #ef4444, #dc2626);
        }
        .btn-red:hover {
            background-image: linear-gradient(to right, #dc2626, #b91c1c);
        }
        .btn-purple {
            background-image: linear-gradient(to right, #a78bfa, #8b5cf6);
        }
        .btn-purple:hover {
            background-image: linear-gradient(to right, #8b5cf6, #7c3aed);
        }

        /* Input group from Encounter Generator */
        .input-group {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap; /* Allow wrapping on small screens */
        }
        .input-group label {
            font-weight: 500;
            color: #a0aec0;
            white-space: nowrap; /* Prevent label from wrapping */
        }
        .input-group input {
            background-color: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            color: #e2e8f0;
            width: 80px; /* Fixed width for inputs */
            text-align: center;
            transition: border-color 0.2s ease-in-out;
        }
        .input-group input:focus {
            outline: none;
            border-color: #63b3ed;
        }

        /* Encounter Generator specific styles */
        .encounter-section {
            background-color: #4a5568; /* Even lighter dark background for sections */
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            text-align: left;
            border: 1px solid #636b77;
        }
        .encounter-section:last-child {
            margin-bottom: 0;
        }
        .encounter-section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #a0aec0; /* Lighter grey for headings */
        }
        .encounter-section p {
            font-size: 1.1rem;
            color: #e2e8f0;
        }
        #difficultyDisplay {
            font-weight: bold;
            color: #a0aec0;
            margin-bottom: 1rem;
        }

        /* Stat Tracker specific styles */
        /* Hide number input arrows */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        .stat-card {
            background-color: #4a5568; /* Consistent with encounter sections */
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #636b77;
        }

        /* Message box styles */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #c53030; /* Red for error */
            color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            max-width: 90%;
            text-align: center;
        }
        .message-box.show {
            opacity: 1;
            visibility: visible;
        }
        .message-box button {
            background-color: #e53e3e;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: none;
            margin-top: 1rem;
            cursor: pointer;
        }

        /* View-specific display */
        .view-section {
            display: none; /* Hidden by default */
            width: 100%;
        }
        .view-section.active {
            display: block; /* Shown when active */
        }
    </style>
</head>
<body>
    <div class="main-container">
        <h1 class="text-5xl font-extrabold mb-8 text-indigo-300">D&D Utility Hub</h1>

        <!-- Home View -->
        <div id="home-view" class="view-section active">
            <h2 class="text-3xl font-semibold mb-8 text-indigo-200">Choose a Utility</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <button class="btn py-4 text-xl view-btn" data-view="tracker-view">
                    Player & Enemy Tracker
                </button>
                <button class="btn py-4 text-xl view-btn" data-view="dice-view">
                    Dice Roller
                </button>
                <button class="btn py-4 text-xl view-btn" data-view="encounter-view">
                    Dynamic Encounter Generator
                </button>
            </div>
        </div>

        <!-- Player & Enemy Tracker View -->
        <div id="tracker-view" class="view-section">
            <button class="btn btn-red mb-8 back-to-home-btn">← Back to Home</button>
            <h2 class="text-3xl font-semibold mb-6 text-indigo-200">Player & Enemy Tracker</h2>
            <!-- Players Section -->
            <div class="mb-10">
                <h3 class="text-2xl font-semibold mb-4 text-indigo-300">Players</h3>
                <div id="players-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Player cards will be injected here by JavaScript -->
                </div>
                <button id="add-player-btn" class="mt-6 w-full py-3 btn btn-green">
                    Add New Player
                </button>
            </div>

            <hr class="border-gray-700 my-10">

            <!-- Enemy HP Tracker Section -->
            <div>
                <h3 class="text-2xl font-semibold mb-4 text-indigo-300">Enemy HP Tracker</h3>
                <div id="enemies-container" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- Enemy cards will be injected here by JavaScript -->
                </div>
                <button id="add-enemy-btn" class="w-full py-3 btn btn-red">
                    Add New Enemy
                </button>
            </div>
        </div>

        <!-- Dice Roller View -->
        <div id="dice-view" class="view-section">
            <button class="btn btn-red mb-8 back-to-home-btn">← Back to Home</button>
            <h2 class="text-3xl font-semibold mb-6 text-indigo-200">Dice Roller</h2>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-7 gap-4 mb-6">
                <button class="dice-btn w-full py-3 btn" data-dice="d4">Roll d4</button>
                <button class="dice-btn w-full py-3 btn" data-dice="d6">Roll d6</button>
                <button class="dice-btn w-full py-3 btn" data-dice="d8">Roll d8</button>
                <button class="dice-btn w-full py-3 btn" data-dice="d10">Roll d10</button>
                <button class="dice-btn w-full py-3 btn" data-dice="d12">Roll d12</button>
                <button class="dice-btn w-full py-3 btn" data-dice="d20">Roll d20</button>
                <button class="dice-btn w-full py-3 btn" data-dice="d100">Roll d100</button>
            </div>
            <div class="flex flex-col sm:flex-row gap-4 mb-6">
                <input type="text" id="custom-dice-input" placeholder="e.g., 2d6+3" class="flex-grow p-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button id="roll-custom-btn" class="w-full sm:w-auto py-3 px-6 btn btn-purple">
                    Roll Custom
                </button>
            </div>
            <div id="dice-results" class="bg-gray-700 p-4 rounded-lg text-lg text-center font-mono">
                Roll results will appear here.
            </div>
        </div>

        <!-- Dynamic Encounter Generator View -->
        <div id="encounter-view" class="view-section">
            <button class="btn btn-red mb-8 back-to-home-btn">← Back to Home</button>
            <h2 class="text-3xl font-semibold mb-6 text-indigo-200">Dynamic Encounter Generator</h2>
            <div class="input-group">
                <label for="playerLevel">Player Level:</label>
                <input type="number" id="playerLevel" value="3" min="1" max="20">

                <label for="partySize">Party Size:</label>
                <input type="number" id="partySize" value="4" min="1" max="10">
            </div>

            <p id="difficultyDisplay" class="mb-4"></p>

            <button id="generateBtn" class="btn mb-8">Generate New Encounter</button>

            <div id="encounterOutput" class="space-y-4">
                <!-- Encounter details will be displayed here -->
                <div class="encounter-section">
                    <h3>Environment:</h3>
                    <p id="environment"></p>
                </div>
                <div class="encounter-section">
                    <h3>Creature(s):</h3>
                    <p id="creature"></p>
                </div>
                <div class="encounter-section">
                    <h3>Objective:</h3>
                    <p id="objective"></p>
                </div>
                <div class="encounter-section">
                    <h3>Complication:</h3>
                    <p id="complication"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Box for errors -->
    <div id="messageBox" class="message-box">
        <p id="messageText"></p>
        <button id="closeMessage">OK</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Common Utility Functions ---
            const generateId = () => Math.random().toString(36).substr(2, 9);

            // Message Box for errors/info
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            const closeMessageBtn = document.getElementById('closeMessage');

            function showMessage(message) {
                messageText.textContent = message;
                messageBox.classList.add('show');
            }

            function hideMessage() {
                messageBox.classList.remove('show');
            }

            closeMessageBtn.addEventListener('click', hideMessage);

            // --- View Management ---
            const views = document.querySelectorAll('.view-section');
            const viewButtons = document.querySelectorAll('.view-btn');
            const backToHomeButtons = document.querySelectorAll('.back-to-home-btn');

            function showView(viewId) {
                views.forEach(view => {
                    view.classList.remove('active');
                });
                document.getElementById(viewId).classList.add('active');

                // Re-run initial generation for Encounter Generator when its view is shown
                if (viewId === 'encounter-view') {
                    generateEncounter();
                }
            }

            viewButtons.forEach(button => {
                button.addEventListener('click', () => {
                    showView(button.dataset.view);
                });
            });

            backToHomeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    showView('home-view');
                });
            });

            // --- D&D Stat Tracker Logic ---
            const APP_STORAGE_KEY = 'dnd-stat-tracker-data'; // Unique ID for local storage
            let appData = {
                players: [],
                enemies: []
            };

            // DOM Elements for Stat Tracker (scoped to tracker-view, but globally accessible via ID)
            const playersContainer = document.getElementById('players-container');
            const addPlayerBtn = document.getElementById('add-player-btn');
            const diceResults = document.getElementById('dice-results');
            const customDiceInput = document.getElementById('custom-dice-input');
            const rollCustomBtn = document.getElementById('roll-custom-btn');
            const enemiesContainer = document.getElementById('enemies-container');
            const addEnemyBtn = document.getElementById('add-enemy-btn');

            // Data Persistence Functions
            const loadData = () => {
                const storedData = localStorage.getItem(APP_STORAGE_KEY);
                if (storedData) {
                    appData = JSON.parse(storedData);
                }
            };

            const saveData = () => {
                localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(appData));
            };

            // Player Management
            const createPlayerCard = (player) => {
                const playerCard = document.createElement('div');
                playerCard.id = `player-${player.id}`;
                playerCard.className = 'stat-card flex flex-col space-y-4'; // Use stat-card class

                // Currency inputs HTML
                const currencyHtml = `
                    <div class="mt-4 border-t border-gray-600 pt-4">
                        <h3 class="text-xl font-semibold mb-3 text-indigo-200">Currency</h3>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                            ${Object.keys(player.currency).map(coin => `
                                <div class="flex items-center justify-between">
                                    <label class="text-sm font-semibold flex-shrink-0 mr-2 uppercase">${coin}:</label>
                                    <input type="number" value="${player.currency[coin]}" data-player-id="${player.id}" data-field="currency.${coin}"
                                           class="player-input w-20 p-1 bg-gray-600 rounded-md border border-gray-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 text-center text-sm flex-shrink-0">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;

                // Magic Items section HTML
                const magicItemsHtml = `
                    <div class="mt-4 border-t border-gray-600 pt-4">
                        <h3 class="text-xl font-semibold mb-3 text-indigo-200">Magic Items</h3>
                        <div id="magic-items-container-${player.id}" class="space-y-3 mb-4 text-left">
                            <!-- Magic items will be rendered here -->
                        </div>
                        <button class="add-magic-item-btn w-full py-2 btn btn-purple text-sm" data-player-id="${player.id}">
                            Add Magic Item
                        </button>
                    </div>
                `;

                playerCard.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <input type="text" value="${player.name}" data-player-id="${player.id}" data-field="name"
                               class="player-name-input text-2xl font-bold bg-transparent border-b border-gray-500 pb-1 focus:outline-none focus:border-indigo-400 w-full mr-2"
                               placeholder="Player Name">
                        <button class="remove-player-btn text-red-400 hover:text-red-500 text-lg font-bold transition duration-200" data-player-id="${player.id}">
                            &times;
                        </button>
                    </div>

                    <!-- Stats -->
                    <div class="grid grid-cols-2 gap-3">
                        ${Object.keys(player.stats).map(stat => `
                            <div class="flex items-center">
                                <label class="uppercase text-sm font-semibold flex-shrink-0 w-1/3 min-w-[40px]">${stat}:</label>
                                <input type="number" value="${player.stats[stat]}" data-player-id="${player.id}" data-field="stats.${stat}"
                                       class="player-input flex-grow p-2 bg-gray-600 rounded-md border border-gray-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 text-center min-w-0">
                            </div>
                        `).join('')}
                    </div>

                    <!-- HP, AC, Initiative, Speed -->
                    <div class="flex flex-col gap-3">
                        <div class="flex items-center">
                            <label class="text-sm font-semibold flex-shrink-0 w-1/4 min-w-[30px] mr-2">HP:</label>
                            <input type="number" value="${player.hp.current}" data-player-id="${player.id}" data-field="hp.current"
                                   class="player-input flex-grow p-2 bg-gray-600 rounded-md border border-gray-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 text-center min-w-0 max-w-[80px]">
                            <span class="mx-1 flex-shrink-0">/</span>
                            <input type="number" value="${player.hp.max}" data-player-id="${player.id}" data-field="hp.max"
                                   class="player-input flex-grow p-2 bg-gray-600 rounded-md border border-gray-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 text-center min-w-0 max-w-[80px]">
                        </div>
                        <div class="flex items-center">
                            <label class="text-sm font-semibold flex-shrink-0 w-1/3 min-w-[30px] mr-2">AC:</label>
                            <input type="number" value="${player.ac}" data-player-id="${player.id}" data-field="ac"
                                   class="player-input flex-grow p-2 bg-gray-600 rounded-md border border-gray-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 text-center min-w-0 max-w-[80px]">
                        </div>
                        <div class="flex items-center">
                            <label class="text-sm font-semibold flex-shrink-0 w-1/3 min-w-[30px] mr-2">Init:</label>
                            <input type="number" value="${player.initiative}" data-player-id="${player.id}" data-field="initiative"
                                   class="player-input flex-grow p-2 bg-gray-600 rounded-md border border-gray-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 text-center min-w-0 max-w-[80px]">
                        </div>
                        <div class="flex items-center">
                            <label class="text-sm font-semibold flex-shrink-0 w-1/3 min-w-[30px] mr-2">Speed:</label>
                            <input type="number" value="${player.speed}" data-player-id="${player.id}" data-field="speed"
                                   class="player-input flex-grow p-2 bg-gray-600 rounded-md border border-gray-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 text-center min-w-0 max-w-[80px]">
                        </div>
                    </div>

                    <!-- Spell Slots -->
                    <div class="mt-4 border-t border-gray-600 pt-4">
                        <h3 class="text-xl font-semibold mb-3 text-indigo-200">Spell Slots</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2">
                            ${Object.keys(player.spellSlots).map(level => `
                                <div class="flex items-center justify-between">
                                    <label class="text-sm font-semibold flex-shrink-0 mr-2">${level.replace('level', '')}${level === 'level1' ? 'st' : level === 'level2' ? 'nd' : level === 'level3' ? 'rd' : 'th'} Level:</label>
                                    <div class="flex items-center flex-grow justify-end">
                                        <button class="spell-slot-btn w-6 h-6 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center text-sm flex-shrink-0 mr-1 transition duration-200" data-player-id="${player.id}" data-level="${level}" data-action="decrement">-</button>
                                        <input type="number" value="${player.spellSlots[level].current}" data-player-id="${player.id}" data-field="spellSlots.${level}.current"
                                               class="player-input w-10 p-1 bg-gray-600 rounded-md border border-gray-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 text-center text-sm flex-shrink-0">
                                        <span class="mx-1 flex-shrink-0">/</span>
                                        <input type="number" value="${player.spellSlots[level].max}" data-player-id="${player.id}" data-field="spellSlots.${level}.max"
                                               class="player-input w-10 p-1 bg-gray-600 rounded-md border border-gray-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 text-center text-sm flex-shrink-0">
                                        <button class="spell-slot-btn w-6 h-6 bg-green-500 hover:bg-green-600 text-white rounded-full flex items-center justify-center text-sm ml-1 flex-shrink-0 transition duration-200" data-player-id="${player.id}" data-level="${level}" data-action="increment">+</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ${currencyHtml}
                    ${magicItemsHtml}
                `;
                return playerCard;
            };

            const addPlayer = () => {
                const newPlayer = {
                    id: generateId(),
                    name: `New Player ${appData.players.length + 1}`,
                    stats: { str: 10, dex: 10, con: 10, int: 10, wis: 10, cha: 10 },
                    hp: { current: 20, max: 20 },
                    ac: 10,
                    initiative: 0,
                    speed: 30,
                    spellSlots: {
                        level1: { current: 0, max: 0 }, level2: { current: 0, max: 0 },
                        level3: { current: 0, max: 0 }, level4: { current: 0, max: 0 },
                        level5: { current: 0, max: 0 }, level6: { current: 0, max: 0 },
                        level7: { current: 0, max: 0 }, level8: { current: 0, max: 0 },
                        level9: { current: 0, max: 0 },
                    },
                    currency: { cp: 0, sp: 0, ep: 0, gp: 0, pp: 0 }, // New currency fields
                    magicItems: [] // New magic items array
                };
                appData.players.push(newPlayer);
                saveData();
                renderPlayers();
            };

            const updatePlayer = (playerId, field, value) => {
                const playerIndex = appData.players.findIndex(p => p.id === playerId);
                if (playerIndex > -1) {
                    const parts = field.split('.');
                    let current = appData.players[playerIndex];
                    for (let i = 0; i < parts.length - 1; i++) {
                        if (!current[parts[i]]) current[parts[i]] = {};
                        current = current[parts[i]];
                    }
                    current[parts[parts.length - 1]] = value;
                    saveData();
                }
            };

            const removePlayer = (playerId) => {
                appData.players = appData.players.filter(p => p.id !== playerId);
                saveData();
                renderPlayers();
            };

            const renderPlayers = () => {
                playersContainer.innerHTML = '';
                appData.players.forEach(player => {
                    const playerCard = createPlayerCard(player);
                    playersContainer.appendChild(playerCard);
                    renderMagicItems(player.id); // Render magic items for each player after card is appended
                });
            };

            // --- Magic Item Management ---
            const renderMagicItems = (playerId) => {
                const player = appData.players.find(p => p.id === playerId);
                if (!player) return;

                const magicItemsContainer = document.getElementById(`magic-items-container-${playerId}`);
                if (!magicItemsContainer) return; // Ensure container exists before trying to render

                magicItemsContainer.innerHTML = ''; // Clear existing items

                player.magicItems.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'bg-gray-700 p-3 rounded-md border border-gray-600 relative';
                    itemDiv.innerHTML = `
                        <button class="remove-magic-item-btn text-red-400 hover:text-red-500 text-lg font-bold absolute top-1 right-2" data-player-id="${player.id}" data-item-id="${item.id}">
                            &times;
                        </button>
                        <input type="text" value="${item.name}" data-player-id="${player.id}" data-item-id="${item.id}" data-field="name"
                               class="magic-item-input w-full p-1 mb-2 bg-gray-800 rounded-md border border-gray-700 focus:outline-none focus:ring-1 focus:ring-indigo-500 text-base font-semibold"
                               placeholder="Magic Item Name">
                        <textarea data-player-id="${player.id}" data-item-id="${item.id}" data-field="description"
                                  class="magic-item-input w-full p-1 bg-gray-800 rounded-md border border-gray-700 focus:outline-none focus:ring-1 focus:ring-indigo-500 text-sm h-20 resize-y"
                                  placeholder="Description of its effects...">${item.description}</textarea>
                    `;
                    magicItemsContainer.appendChild(itemDiv);
                });
            };

            const addMagicItem = (playerId) => {
                const player = appData.players.find(p => p.id === playerId);
                if (player) {
                    const newItem = {
                        id: generateId(),
                        name: "New Magic Item",
                        description: ""
                    };
                    player.magicItems.push(newItem);
                    saveData();
                    renderMagicItems(playerId); // Re-render only this player's magic items
                }
            };

            const updateMagicItem = (playerId, itemId, field, value) => {
                const player = appData.players.find(p => p.id === playerId);
                if (player) {
                    const item = player.magicItems.find(i => i.id === itemId);
                    if (item) {
                        item[field] = value;
                        saveData();
                    }
                }
            };

            const removeMagicItem = (playerId, itemId) => {
                const player = appData.players.find(p => p.id === playerId);
                if (player) {
                    player.magicItems = player.magicItems.filter(item => item.id !== itemId);
                    saveData();
                    renderMagicItems(playerId); // Re-render only this player's magic items
                }
            };


            // Dice Roller
            const rollDice = (diceType) => {
                let result;
                switch (diceType) {
                    case 'd4': result = Math.floor(Math.random() * 4) + 1; break;
                    case 'd6': result = Math.floor(Math.random() * 6) + 1; break;
                    case 'd8': result = Math.floor(Math.random() * 8) + 1; break;
                    case 'd10': result = Math.floor(Math.random() * 10) + 1; break;
                    case 'd12': result = Math.floor(Math.random() * 12) + 1; break;
                    case 'd20': result = Math.floor(Math.random() * 20) + 1; break;
                    case 'd100': result = Math.floor(Math.random() * 100) + 1; break;
                    default: result = 0;
                }
                return result;
            };

            const parseAndRollCustomDice = (input) => {
                const match = input.toLowerCase().match(/^(\d*)d(\d+)([+-]\d+)?$/);
                if (!match) {
                    diceResults.textContent = 'Invalid format. Use like: 2d6+3 or d20';
                    return;
                }

                const numDice = parseInt(match[1] || '1', 10);
                const diceSides = parseInt(match[2], 10);
                const modifier = parseInt(match[3] || '0', 10);

                if (isNaN(numDice) || isNaN(diceSides) || isNaN(modifier) || numDice <= 0 || diceSides <= 0) {
                    diceResults.textContent = 'Invalid numbers in dice roll.';
                    return;
                }

                let total = 0;
                let rolls = [];
                for (let i = 0; i < numDice; i++) {
                    const roll = Math.floor(Math.random() * diceSides) + 1;
                    rolls.push(roll);
                    total += roll;
                }

                const finalResult = total + modifier;
                let resultText = `Rolling ${input}: `;
                if (numDice > 1) {
                    resultText += `Rolls (${rolls.join(' + ')})`;
                    if (modifier !== 0) {
                        resultText += ` ${modifier > 0 ? '+' : ''}${modifier}`;
                    }
                    resultText += ` = ${finalResult}`;
                } else {
                    resultText += `${finalResult}`;
                }
                diceResults.textContent = resultText;
            };

            // Enemy HP Tracker
            const createEnemyCard = (enemy) => {
                const enemyCard = document.createElement('div');
                enemyCard.id = `enemy-${enemy.id}`;
                enemyCard.className = 'stat-card flex flex-col space-y-4'; // Use stat-card class

                enemyCard.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <input type="text" value="${enemy.name}" data-enemy-id="${enemy.id}" data-field="name"
                               class="enemy-name-input text-2xl font-bold bg-transparent border-b border-gray-500 pb-1 focus:outline-none focus:border-red-400 w-full mr-2"
                               placeholder="Enemy Name">
                        <button class="remove-enemy-btn text-red-400 hover:text-red-500 text-lg font-bold transition duration-200" data-enemy-id="${enemy.id}">
                            &times;
                        </button>
                    </div>

                    <div class="flex items-center justify-between">
                        <label class="text-sm font-semibold flex-shrink-0 mr-2">HP:</label>
                        <div class="flex items-center flex-grow justify-end">
                            <button class="enemy-hp-btn w-8 h-8 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center text-lg flex-shrink-0 mr-2 transition duration-200" data-enemy-id="${enemy.id}" data-action="decrement">-</button>
                            <input type="number" value="${enemy.hp}" data-enemy-id="${enemy.id}" data-field="hp"
                                   class="enemy-input w-20 p-2 bg-gray-600 rounded-md border border-gray-500 focus:outline-none focus:ring-1 focus:ring-red-500 text-center text-lg flex-shrink-0">
                            <button class="enemy-hp-btn w-8 h-8 bg-green-500 hover:bg-green-600 text-white rounded-full flex items-center justify-center text-lg ml-2 flex-shrink-0 transition duration-200" data-enemy-id="${enemy.id}" data-action="increment">+</button>
                        </div>
                    </div>
                `;
                return enemyCard;
            };

            const addEnemy = () => {
                const newEnemy = {
                    id: generateId(),
                    name: `New Enemy ${appData.enemies.length + 1}`,
                    hp: 10
                };
                appData.enemies.push(newEnemy);
                saveData();
                renderEnemies();
            };

            const updateEnemy = (enemyId, field, value) => {
                const enemyIndex = appData.enemies.findIndex(e => e.id === enemyId);
                if (enemyIndex > -1) {
                    const parts = field.split('.');
                    let current = appData.enemies[enemyIndex];
                    for (let i = 0; i < parts.length - 1; i++) {
                        if (!current[parts[i]]) current[parts[i]] = {};
                        current = current[parts[i]];
                    }
                    current[parts[parts.length - 1]] = value;
                    saveData();
                }
            };

            const removeEnemy = (enemyId) => {
                appData.enemies = appData.enemies.filter(e => e.id !== enemyId);
                saveData();
                renderEnemies();
            };

            const renderEnemies = () => {
                enemiesContainer.innerHTML = '';
                appData.enemies.forEach(enemy => {
                    enemiesContainer.appendChild(createEnemyCard(enemy));
                });
            };

            // --- Dynamic Encounter Generator Logic ---
            // DOM Elements for Encounter Generator
            const generateBtn = document.getElementById('generateBtn');
            const playerLevelInput = document.getElementById('playerLevel');
            const partySizeInput = document.getElementById('partySize');
            const difficultyDisplay = document.getElementById('difficultyDisplay');
            const environmentEl = document.getElementById('environment');
            const creatureEl = document.getElementById('creature');
            const objectiveEl = document.getElementById('objective');
            const complicationEl = document.getElementById('complication');

            // Encounter Data with Difficulty Ranges (1-20)
            const environments = [
                { text: "a tranquil forest clearing bathed in morning light", min_difficulty: 1, max_difficulty: 3 },
                { text: "a bustling marketplace at dusk, filled with diverse crowds", min_difficulty: 2, max_difficulty: 6 },
                { text: "a winding river path near ancient, crumbling ruins", min_difficulty: 4, max_difficulty: 8 },
                { text: "a dense, mist-shrouded forest with eerie silence", min_difficulty: 5, max_difficulty: 10 },
                { text: "a treacherous mountain pass, narrow and windswept", min_difficulty: 7, max_difficulty: 12 },
                { text: "a scorched desert canyon, baking under twin suns", min_difficulty: 8, max_difficulty: 13 },
                { text: "a dark, echoing cave system, dripping with unseen water", min_difficulty: 9, max_difficulty: 14 },
                { text: "a forgotten, overgrown swamp, thick with stagnant air", min_difficulty: 10, max_difficulty: 15 },
                { text: "the suffocating depths of an abyssal trench, lit by bioluminescence", min_difficulty: 12, max_difficulty: 17 },
                { text: "a desolate, volcanic wasteland, scarred by recent eruptions", min_difficulty: 14, max_difficulty: 18 },
                { text: "a vibrant, alien jungle, teeming with strange flora and fauna", min_difficulty: 15, max_difficulty: 19 },
                { text: "the desolate ruins of a forgotten metropolis, reclaimed by nature", min_difficulty: 11, max_difficulty: 16 },
                { text: "a snow-blasted tundra, where the wind howls like a banshee", min_difficulty: 9, max_difficulty: 14 },
                { text: "a hidden, magical grove pulsating with ancient energy", min_difficulty: 6, max_difficulty: 11 },
                { text: "the chaotic underbelly of a sprawling steampunk city", min_difficulty: 7, max_difficulty: 12 },
                { text: "a haunted graveyard, where restless spirits linger", min_difficulty: 5, max_difficulty: 9 },
                { text: "a serene, floating island in the sky, accessible only by magic", min_difficulty: 13, max_difficulty: 18 },
                { text: "the crystalline caverns of an ice giant's lair", min_difficulty: 16, max_difficulty: 20 },
                { text: "a bustling pirate port, rife with shady dealings", min_difficulty: 4, max_difficulty: 8 },
                { text: "an ethereal plane, shifting and unpredictable", min_difficulty: 17, max_difficulty: 20 },
                { text: "a forgotten temple deep within a treacherous jungle, overgrown and crumbling", min_difficulty: 13, max_difficulty: 17 },
                { text: "the shimmering halls of an elemental plane of fire, where the air itself burns", min_difficulty: 18, max_difficulty: 20 },
                { text: "a desolate, wind-scoured plateau dotted with ancient, ominous monoliths", min_difficulty: 10, max_difficulty: 14 },
                { text: "a charming, isolated village suddenly gripped by an unnatural, eternal winter", min_difficulty: 6, max_difficulty: 10 },
                { text: "the bustling, multi-tiered city of a subterranean race, carved into solid rock", min_difficulty: 8, max_difficulty: 13 },
                // --- NEW ENVIRONMENTS (100 new entries) ---
                { text: "a sun-drenched coastal town, preparing for a festival", min_difficulty: 1, max_difficulty: 4 },
                { text: "a quiet, rural farmstead at harvest time", min_difficulty: 1, max_difficulty: 3 },
                { text: "a winding forest trail, dotted with ancient, moss-covered trees", min_difficulty: 2, max_difficulty: 5 },
                { text: "a small, secluded fishing village nestled by a calm bay", min_difficulty: 2, max_difficulty: 4 },
                { text: "a crumbling watchtower overlooking a peaceful valley", min_difficulty: 3, max_difficulty: 6 },
                { text: "a bustling trade road, frequently traveled by merchants", min_difficulty: 3, max_difficulty: 5 },
                { text: "a serene elven glade, filled with whispering winds", min_difficulty: 4, max_difficulty: 7 },
                { text: "a forgotten shrine dedicated to a minor nature deity", min_difficulty: 4, max_difficulty: 6 },
                { text: "a lively tavern in a frontier town, full of boisterous patrons", min_difficulty: 1, max_difficulty: 5 },
                { text: "a small, overgrown ruin of an old farmhouse", min_difficulty: 1, max_difficulty: 2 },
                { text: "a misty moorland, where ancient standing stones pierce the fog", min_difficulty: 5, max_difficulty: 9 },
                { text: "a shadowed alleyway in a large city, bustling with hidden activity", min_difficulty: 6, max_difficulty: 10 },
                { text: "a forgotten crypt beneath a venerable church, filled with dust and silence", min_difficulty: 7, max_difficulty: 11 },
                { text: "a section of a vast sewer system, echoing with unseen movement", min_difficulty: 6, max_difficulty: 9 },
                { text: "a storm-battered coastline, with jagged rocks and crashing waves", min_difficulty: 8, max_difficulty: 12 },
                { text: "a bandit-infested forest, with crude traps and hidden paths", min_difficulty: 7, max_difficulty: 10 },
                { text: "a desolate battlefield, still bearing the scars of a past conflict", min_difficulty: 9, max_difficulty: 13 },
                { text: "a forgotten mine shaft, dark and unstable, with faint sounds of dripping water", min_difficulty: 8, max_difficulty: 11 },
                { text: "a bustling dwarven forge, hot and loud, with sparks flying", min_difficulty: 5, max_difficulty: 8 },
                { text: "a haunted mansion on the outskirts of a town, its windows like empty eyes", min_difficulty: 6, max_difficulty: 10 },
                { text: "a treacherous bog, where the ground is uncertain and strange plants grow", min_difficulty: 9, max_difficulty: 14 },
                { text: "a forgotten temple dedicated to a forgotten god, overgrown and crumbling", min_difficulty: 10, max_difficulty: 14 },
                { text: "a section of a sprawling underground city, lit by strange fungi", min_difficulty: 11, max_difficulty: 15 },
                { text: "a desolate, wind-scoured plateau dotted with ancient, ominous monoliths", min_difficulty: 10, max_difficulty: 14 },
                { text: "a charming, isolated village suddenly gripped by an unnatural, eternal winter", min_difficulty: 6, max_difficulty: 10 },
                { text: "the bustling, multi-tiered city of a subterranean race, carved into solid rock", min_difficulty: 8, max_difficulty: 13 },
                { text: "a forgotten library, filled with crumbling scrolls and ancient knowledge", min_difficulty: 7, max_difficulty: 12 },
                { text: "a cursed graveyard, where restless spirits linger among the tombstones", min_difficulty: 5, max_difficulty: 9 },
                { text: "a vibrant, but dangerous, jungle canopy, teeming with unseen life", min_difficulty: 12, max_difficulty: 16 },
                { text: "a floating island in the sky, accessible only by ancient magic", min_difficulty: 13, max_difficulty: 18 },
                { text: "the crystalline caverns of an ice giant's lair, shimmering with blue light", min_difficulty: 16, max_difficulty: 20 },
                { text: "a bustling pirate port, rife with shady dealings and loud revelry", min_difficulty: 4, max_difficulty: 8 },
                { text: "an ethereal plane, shifting and unpredictable, with strange colors", min_difficulty: 17, max_difficulty: 20 },
                { text: "a forgotten temple deep within a treacherous jungle, overgrown and crumbling", min_difficulty: 13, max_difficulty: 17 },
                { text: "the shimmering halls of an elemental plane of fire, where the air itself burns", min_difficulty: 18, max_difficulty: 20 },
                { text: "a desolate, wind-scoured plateau dotted with ancient, ominous monoliths", min_difficulty: 10, max_difficulty: 14 },
                { text: "a charming, isolated village suddenly gripped by an unnatural, eternal winter", min_difficulty: 6, max_difficulty: 10 },
                { text: "the bustling, multi-tiered city of a subterranean race, carved into solid rock", min_difficulty: 8, max_difficulty: 13 },
                { text: "a desolate arctic research station, buried in snow and ice", min_difficulty: 14, max_difficulty: 18 },
                { text: "a thriving oasis in a vast, scorching desert, a beacon of life", min_difficulty: 7, max_difficulty: 11 },
                { text: "the chaotic streets of a war-torn city, rubble and fear everywhere", min_difficulty: 15, max_difficulty: 19 },
                { text: "a hidden, subterranean lake, glowing with phosphorescent algae", min_difficulty: 11, max_difficulty: 15 },
                { text: "a forgotten wizard's tower, filled with strange magical energies", min_difficulty: 12, max_difficulty: 16 },
                { text: "the heart of a massive, ancient tree, alive with nature's power", min_difficulty: 10, max_difficulty: 14 },
                { text: "a treacherous glacier, constantly shifting and cracking", min_difficulty: 13, max_difficulty: 17 },
                { text: "a bustling port city, with ships from far-off lands", min_difficulty: 5, max_difficulty: 9 },
                { text: "a deep, silent chasm, with unseen horrors lurking below", min_difficulty: 16, max_difficulty: 20 },
                { text: "a vibrant coral reef, teeming with colorful but dangerous marine life", min_difficulty: 9, max_difficulty: 13 },
                { text: "a desolate asteroid field, drifting through the void", min_difficulty: 17, max_difficulty: 20 },
                { text: "a forgotten prison dimension, holding ancient evils", min_difficulty: 18, max_difficulty: 20 },
                { text: "a shimmering pocket dimension, where gravity shifts", min_difficulty: 15, max_difficulty: 19 },
                { text: "a bustling goblin market, chaotic and full of strange wares", min_difficulty: 3, max_difficulty: 7 },
                { text: "a secluded hermit's hut in the wilderness, surrounded by strange wards", min_difficulty: 2, max_difficulty: 5 },
                { text: "a haunted lighthouse overlooking a stormy sea", min_difficulty: 8, max_difficulty: 12 },
                { text: "a vibrant feywild glade, where illusions dance", min_difficulty: 10, max_difficulty: 14 },
                { text: "a crumbling fortress on a volcanic peak, spewing ash", min_difficulty: 14, max_difficulty: 18 },
                { text: "a dimension of pure shadow, where light is an anomaly", min_difficulty: 19, max_difficulty: 20 },
                { text: "a bustling city district under martial law, tense and quiet", min_difficulty: 11, max_difficulty: 15 },
                { text: "a forgotten temple to a death god, filled with skeletal remains", min_difficulty: 12, max_difficulty: 16 },
                { text: "a vibrant, bioluminescent cave system, full of strange life", min_difficulty: 9, max_difficulty: 13 },
                { text: "a shifting labyrinth of ice, constantly reforming", min_difficulty: 13, max_difficulty: 17 },
                { text: "a war-torn trench network, muddy and dangerous", min_difficulty: 7, max_difficulty: 11 },
                { text: "a serene monastery high in the mountains, isolated", min_difficulty: 6, max_difficulty: 10 },
                { text: "a bustling trade caravan crossing open plains", min_difficulty: 2, max_difficulty: 6 },
                { text: "a dense, thorny thicket, difficult to traverse", min_difficulty: 4, max_difficulty: 8 },
                { text: "a forgotten, flooded village, submerged and eerie", min_difficulty: 5, max_difficulty: 9 },
                { text: "a vibrant, but toxic, mushroom forest, glowing faintly", min_difficulty: 10, max_difficulty: 14 },
                { text: "a ruined bridge spanning a raging river", min_difficulty: 7, max_difficulty: 11 },
                { text: "a deep, dark well, rumored to lead to other planes", min_difficulty: 15, max_difficulty: 19 },
                { text: "a bustling, multi-cultural bazaar, full of exotic goods", min_difficulty: 3, max_difficulty: 7 },
                { text: "a frozen lake, with cracks appearing in the ice", min_difficulty: 8, max_difficulty: 12 },
                { text: "a hidden, underground arena, for gladiatorial combat", min_difficulty: 11, max_difficulty: 15 },
                { text: "a desolate, alien landscape, with strange rock formations", min_difficulty: 16, max_difficulty: 20 },
                { text: "a thriving, hidden smuggler's cove", min_difficulty: 6, max_difficulty: 10 },
                { text: "a forgotten, ancient battlefield, where echoes of war linger", min_difficulty: 12, max_difficulty: 16 },
                { text: "a bustling, but impoverished, slum district", min_difficulty: 4, max_difficulty: 8 },
                { text: "a serene, but magically volatile, forest spring", min_difficulty: 9, max_difficulty: 13 },
                { text: "a crumbling, mist-shrouded castle on a hill", min_difficulty: 13, max_difficulty: 17 },
                { text: "a dimension of pure thought, where ideas manifest", min_difficulty: 18, max_difficulty: 20 },
                { text: "a bustling, but heavily guarded, royal treasury", min_difficulty: 14, max_difficulty: 18 },
                { text: "a forgotten, overgrown observatory, pointing to strange stars", min_difficulty: 10, max_difficulty: 14 },
                { text: "a vibrant, but dangerous, urban rooftop chase", min_difficulty: 7, max_difficulty: 11 },
                { text: "a desolate, frozen wasteland, with blizzards raging", min_difficulty: 15, max_difficulty: 19 },
                { text: "a hidden, magical library, protected by ancient spells", min_difficulty: 12, max_difficulty: 16 },
                { text: "a bustling, but crime-ridden, docks district", min_difficulty: 5, max_difficulty: 9 },
                { text: "a forgotten, flooded dungeon, with water-logged passages", min_difficulty: 8, max_difficulty: 12 },
                { text: "a vibrant, but highly competitive, arena for magical duels", min_difficulty: 11, max_difficulty: 15 },
                { text: "a desolate, wind-swept desert with shifting sands", min_difficulty: 9, max_difficulty: 13 },
                { text: "a hidden, ancient tomb, filled with traps and guardians", min_difficulty: 13, max_difficulty: 17 },
                { text: "a bustling, but heavily taxed, farming community", min_difficulty: 2, max_difficulty: 6 },
                { text: "a forgotten, magically warped forest, with strange flora", min_difficulty: 10, max_difficulty: 14 },
                { text: "a vibrant, but heavily polluted, industrial district", min_difficulty: 6, max_difficulty: 10 },
                { text: "a desolate, war-torn borderland, with constant skirmishes", min_difficulty: 14, max_difficulty: 18 },
                { text: "a hidden, celestial garden, guarded by angels", min_difficulty: 17, max_difficulty: 20 },
                { text: "a bustling, but tightly controlled, magical academy", min_difficulty: 10, max_difficulty: 14 },
                { text: "a forgotten, cursed shipwreck, at the bottom of the sea", min_difficulty: 12, max_difficulty: 16 },
                { text: "a vibrant, but politically charged, royal court", min_difficulty: 7, max_difficulty: 11 },
                { text: "a desolate, haunted swamp, with eerie lights", min_difficulty: 9, max_difficulty: 13 },
                { text: "a hidden, ancient laboratory, filled with dangerous experiments", min_difficulty: 15, max_difficulty: 19 },
                { text: "a bustling, but heavily fortified, mountain pass", min_difficulty: 8, max_difficulty: 12 },
                { text: "a forgotten, magically sealed vault, deep underground", min_difficulty: 16, max_difficulty: 20 },
                { text: "a vibrant, but disease-ridden, refugee camp", min_difficulty: 5, max_difficulty: 9 },
                { text: "a desolate, post-apocalyptic cityscape, overgrown", min_difficulty: 14, max_difficulty: 18 },
                { text: "a hidden, ethereal library, accessible only to spirits", min_difficulty: 18, max_difficulty: 20 },
                { text: "a bustling, but heavily taxed, mining town", min_difficulty: 4, max_difficulty: 8 },
                { text: "a forgotten, magically active volcano, on the verge of eruption", min_difficulty: 17, max_difficulty: 20 },
                { text: "a vibrant, but extremely dangerous, elemental rift", min_difficulty: 19, max_difficulty: 20 },
                { text: "a desolate, alien cityscape, abandoned and crumbling", min_difficulty: 16, max_difficulty: 20 },
                { text: "a hidden, ancient observatory, tracking cosmic horrors", min_difficulty: 15, max_difficulty: 19 },
                { text: "a bustling, but heavily guarded, magical artifact market", min_difficulty: 10, max_difficulty: 14 },
                { text: "a forgotten, cursed forest, where trees whisper secrets", min_difficulty: 11, max_difficulty: 15 },
                { text: "a vibrant, but politically unstable, desert kingdom", min_difficulty: 13, max_difficulty: 17 },
                { text: "a desolate, frozen tundra, with ancient ice structures", min_difficulty: 14, max_difficulty: 18 },
                { text: "a hidden, celestial temple, visited by divine beings", min_difficulty: 17, max_difficulty: 20 },
                { text: "a bustling, but heavily patrolled, border outpost", min_difficulty: 6, max_difficulty: 10 },
                { text: "a forgotten, magically sealed ruin, deep in a swamp", min_difficulty: 12, max_difficulty: 16 },
                { text: "a vibrant, but chaotic, street carnival", min_difficulty: 3, max_difficulty: 7 },
                { text: "a desolate, ash-choked plain, near a dormant volcano", min_difficulty: 9, max_difficulty: 13 },
                { text: "a hidden, ancient vault, protected by arcane traps", min_difficulty: 16, max_difficulty: 20 },
                { text: "a bustling, but heavily guarded, royal palace", min_difficulty: 10, max_difficulty: 14 },
                { text: "a forgotten, magically active ruin, in a desert canyon", min_difficulty: 11, max_difficulty: 15 },
                { text: "a vibrant, but dangerous, underground mushroom forest", min_difficulty: 8, max_difficulty: 12 },
                { text: "a desolate, wind-blasted mountain peak, with scarce cover", min_difficulty: 15, max_difficulty: 19 },
                { text: "a hidden, celestial portal, leading to other planes", min_difficulty: 18, max_difficulty: 20 }
            ];

            const creatures = [
                // Low Difficulty (1-5)
                { text: "a lone, injured wolf seeking shelter", min_difficulty: 1, max_difficulty: 3 },
                { text: "a small band of petty thieves, easily startled", min_difficulty: 2, max_difficulty: 5 },
                { text: "a mischievous sprite causing minor inconveniences", min_difficulty: 1, max_difficulty: 4 },
                { text: "a pack of hungry, territorial wolves", min_difficulty: 3, max_difficulty: 7 },
                { text: "a few agitated giant rats scurrying from the shadows", min_difficulty: 1, max_difficulty: 2 },
                { text: "a curious, but harmless, forest spirit observing from afar", min_difficulty: 1, max_difficulty: 3 },
                { text: "a group of lost, non-hostile commoners seeking aid", min_difficulty: 1, max_difficulty: 2 },
                { text: "a single, weak zombie shambling aimlessly", min_difficulty: 2, max_difficulty: 4 },
                { text: "a flock of aggressive stirges attempting to feed", min_difficulty: 3, max_difficulty: 5 },
                { text: "a grumpy badger defending its sett", min_difficulty: 1, max_difficulty: 2 },

                // Medium Difficulty (6-10)
                { text: "a cunning band of goblins setting up an ambush", min_difficulty: 5, max_difficulty: 9 },
                { text: "a swarm of aggressive giant spiders guarding their nest", min_difficulty: 6, max_difficulty: 10 },
                { text: "a lone, desperate troll guarding a bridge", min_difficulty: 6, max_difficulty: 10 },
                { text: "a patrol of restless undead skeletons", min_difficulty: 7, max_difficulty: 11 },
                { text: "a group of well-equipped bounty hunters pursuing a target", min_difficulty: 7, max_difficulty: 12 },
                { text: "a hulking, dim-witted ogre demanding tribute", min_difficulty: 8, max_difficulty: 12 },
                { text: "a hive of intelligent, aggressive insectoids", min_difficulty: 9, max_difficulty: 14 },
                { text: "a group of disillusioned mercenaries, heavily armed", min_difficulty: 9, max_difficulty: 13 },
                { text: "a dire bear defending its territory fiercely, enraged by intruders", min_difficulty: 7, max_difficulty: 11 },
                { text: "a pack of ravenous ghouls emerging from graves", min_difficulty: 6, max_difficulty: 9 },
                { text: "a cunning displacer beast toying with its prey", min_difficulty: 8, max_difficulty: 11 },
                { text: "a band of hobgoblins enacting a military drill", min_difficulty: 6, max_difficulty: 10 },
                { text: "a shambling mound, a plant creature seeking nutrients", min_difficulty: 9, max_difficulty: 12 },
                { text: "a reclusive druid testing the party's intentions", min_difficulty: 7, max_difficulty: 10 },
                { text: "a minor demon summoned by accident, causing chaos", min_difficulty: 8, max_difficulty: 11 },

                // High Difficulty (11-15)
                { text: "a territorial griffin defending its aerie", min_difficulty: 10, max_difficulty: 14 },
                { text: "a curious, displaced elemental, lashing out in confusion", min_difficulty: 11, max_difficulty: 15 },
                { text: "a small cult performing a dark, unsettling ritual", min_difficulty: 12, max_difficulty: 16 },
                { text: "a powerful, ancient treant awakened from slumber", min_difficulty: 13, max_difficulty: 17 },
                { text: "a spectral knight, bound to its ancient duty", min_difficulty: 10, max_difficulty: 15 },
                { text: "a stone giant patrol, hurling massive boulders with terrifying accuracy", min_difficulty: 11, max_difficulty: 15 },
                { text: "a remorhaz, burrowing through ice and rock", min_difficulty: 12, max_difficulty: 15 },
                { text: "a gorgon, turning trespassers to stone with a glance", min_difficulty: 13, max_difficulty: 16 },
                { text: "a cunning vampire spawn preying on travelers", min_difficulty: 14, max_difficulty: 18 },
                { text: "a formidable minotaur guarding its labyrinth", min_difficulty: 11, max_difficulty: 14 },
                { text: "a fierce young white dragon defending its icy lair", min_difficulty: 13, max_difficulty: 16 },
                { text: "a band of drow elite warriors ambushing from the shadows", min_difficulty: 12, max_difficulty: 15 },
                { text: "a powerful golem, animated by ancient magic, defending a vault", min_difficulty: 14, max_difficulty: 17 },
                { text: "a swarm of intellect devourers seeking hosts, their minds hungry for brains", min_difficulty: 14, max_difficulty: 17 },
                { text: "a formidable adult owlbear, highly aggressive and territorial", min_difficulty: 10, max_difficulty: 13 },

                // Very High Difficulty (16-20)
                { text: "a ferocious chimera, a beast of multiple parts", min_difficulty: 16, max_difficulty: 19 },
                { text: "a young dragon defending its hoard", min_difficulty: 15, max_difficulty: 18 },
                { text: "a frost giant chieftain leading a raiding party", min_difficulty: 14, max_difficulty: 17 },
                { text: "a beholder lurking in its lair, paranoid and powerful", min_difficulty: 17, max_difficulty: 20 },
                { text: "an ancient red dragon, a force of nature", min_difficulty: 19, max_difficulty: 20 },
                { text: "a storm giant patrol, wielding immense elemental power", min_difficulty: 16, max_difficulty: 19 },
                { text: "a demon lord's vanguard, tearing through the fabric of reality", min_difficulty: 18, max_difficulty: 20 },
                { text: "a colossal kraken emerging from the depths", min_difficulty: 17, max_difficulty: 20 },
                { text: "a lich and its undead retinue, seeking forbidden knowledge", min_difficulty: 16, max_difficulty: 19 },
                { text: "a githyanki war party on an astral raid, seeking psionic treasures", min_difficulty: 17, max_difficulty: 20 },
                { text: "a mind flayer and its thralls, seeking new victims for their gruesome experiments", min_difficulty: 18, max_difficulty: 20 },
                { text: "a powerful arch-devil or demon leading a legion of lesser fiends", min_difficulty: 19, max_difficulty: 20 },
                { text: "a colossal elder elemental, unleashed and rampaging", min_difficulty: 17, max_difficulty: 20 },
                { text: "a highly intelligent and manipulative aboleth, controlling a vast network of minions", min_difficulty: 16, max_difficulty: 19 },
                { text: "a legendary monstrous beast, unique and devastating, guarding an ancient secret", min_difficulty: 18, max_difficulty: 20 },
                { text: "a powerful vampire lord and their court, defending their ancestral castle", min_difficulty: 17, max_difficulty: 20 },
                { text: "a celestial being, fallen or corrupted, challenging the party's morality", min_difficulty: 15, max_difficulty: 18 },
                { text: "a full-fledged army of well-trained orcs led by a war chief", min_difficulty: 14, max_difficulty: 17 },
                { text: "a powerful genie, capricious and dangerous, granting twisted wishes", min_difficulty: 15, max_difficulty: 18 },
                { text: "a territorial ancient green dragon, master of its poisonous swamp", min_difficulty: 19, max_difficulty: 20 },
                // --- NEW CREATURES (100 new entries) ---
                { text: "a curious forest gnome, observing from the trees", min_difficulty: 1, max_difficulty: 2 },
                { text: "a pair of hungry giant weasels, scavenging for food", min_difficulty: 2, max_difficulty: 4 },
                { text: "a lone, lost grick, disoriented and lashing out", min_difficulty: 3, max_difficulty: 6 },
                { text: "a small group of kobolds, setting up crude traps", min_difficulty: 1, max_difficulty: 3 },
                { text: "a cautious blink dog, observing from a distance", min_difficulty: 2, max_difficulty: 3 },
                { text: "a few agitated giant centipedes, disturbed from their nest", min_difficulty: 1, max_difficulty: 1 },
                { text: "a friendly awakened shrub, eager to communicate", min_difficulty: 1, max_difficulty: 2 },
                { text: "a single, confused ghoul, wandering aimlessly", min_difficulty: 3, max_difficulty: 5 },
                { text: "a small swarm of bats, startled by the party's presence", min_difficulty: 1, max_difficulty: 1 },
                { text: "a grumpy dwarf prospector, defending his claim", min_difficulty: 2, max_difficulty: 4 },
                { text: "a band of experienced bugbears, leading a small raiding party", min_difficulty: 6, max_difficulty: 10 },
                { text: "a cunning mimic, disguised as a common object", min_difficulty: 7, max_difficulty: 11 },
                { text: "a territorial owlbear, defending its nest aggressively", min_difficulty: 8, max_difficulty: 12 },
                { text: "a patrol of disciplined duergar, searching for escaped slaves", min_difficulty: 9, max_difficulty: 13 },
                { text: "a group of well-armed cultists, performing a minor ritual", min_difficulty: 7, max_difficulty: 11 },
                { text: "a powerful wight, raising a small contingent of zombies", min_difficulty: 8, max_difficulty: 12 },
                { text: "a hungry chuul, lurking in murky waters", min_difficulty: 9, max_difficulty: 13 },
                { text: "a group of desperate bandits, cornered and dangerous", min_difficulty: 5, max_difficulty: 8 },
                { text: "a powerful earth elemental, summoned by accident", min_difficulty: 10, max_difficulty: 14 },
                { text: "a cunning succubus/incubus, attempting to charm the party", min_difficulty: 11, max_difficulty: 15 },
                { text: "a territorial young black dragon, guarding its swampy lair", min_difficulty: 12, max_difficulty: 16 },
                { text: "a powerful gorgon, turning trespassers to stone with its gaze", min_difficulty: 13, max_difficulty: 17 },
                { text: "a small squadron of skilled assassins, targeting a party member", min_difficulty: 14, max_difficulty: 18 },
                { text: "a powerful stone giant, hurling massive boulders with ease", min_difficulty: 11, max_difficulty: 15 },
                { text: "a cunning mind flayer, attempting to capture new thralls", min_difficulty: 15, max_difficulty: 19 },
                { text: "a formidable adult red dragon, defending its volcanic lair", min_difficulty: 18, max_difficulty: 20 },
                { text: "a powerful lich, accompanied by a retinue of undead horrors", min_difficulty: 19, max_difficulty: 20 },
                { text: "a colossal kraken, emerging from the depths to wreak havoc", min_difficulty: 17, max_difficulty: 20 },
                { text: "a powerful arch-devil, leading a legion of lesser fiends", min_difficulty: 19, max_difficulty: 20 },
                { text: "a celestial being, fallen from grace and seeking redemption/vengeance", min_difficulty: 16, max_difficulty: 19 },
                { text: "a playful pseudodragon, seeking a new companion", min_difficulty: 1, max_difficulty: 3 },
                { text: "a pack of hungry hyenas, scavenging for easy prey", min_difficulty: 2, max_difficulty: 4 },
                { text: "a nervous goblin scout, caught off guard", min_difficulty: 1, max_difficulty: 2 },
                { text: "a small band of cult fanatics, attempting to convert passersby", min_difficulty: 3, max_difficulty: 5 },
                { text: "a solitary giant toad, waiting for unsuspecting prey", min_difficulty: 2, max_difficulty: 4 },
                { text: "a curious faerie dragon, observing with mischievous intent", min_difficulty: 1, max_difficulty: 3 },
                { text: "a group of lost commoners, seeking directions and safety", min_difficulty: 1, max_difficulty: 2 },
                { text: "a single, weak skeleton, animated by residual magic", min_difficulty: 2, max_difficulty: 3 },
                { text: "a small flock of harpies, singing an eerie song", min_difficulty: 4, max_difficulty: 6 },
                { text: "a grumpy awakened tree, blocking a path", min_difficulty: 3, max_difficulty: 5 },
                { text: "a cunning hobgoblin captain, leading a disciplined patrol", min_difficulty: 7, max_difficulty: 11 },
                { text: "a territorial bullette, burrowing through the earth", min_difficulty: 8, max_difficulty: 12 },
                { text: "a powerful banshee, wailing a mournful cry", min_difficulty: 9, max_difficulty: 13 },
                { text: "a group of desperate gnolls, raiding for supplies", min_difficulty: 6, max_difficulty: 10 },
                { text: "a cunning wererat, blending into the urban environment", min_difficulty: 7, max_difficulty: 11 },
                { text: "a powerful cyclops, guarding a forgotten ruin", min_difficulty: 10, max_difficulty: 14 },
                { text: "a hive of aggressive ankhegs, bursting from the ground", min_difficulty: 9, max_difficulty: 13 },
                { text: "a group of disillusioned veterans, seeking a final fight", min_difficulty: 8, max_difficulty: 12 },
                { text: "a fierce grick alpha, leading its pack", min_difficulty: 10, max_difficulty: 14 },
                { text: "a powerful young blue dragon, defending its desert territory", min_difficulty: 13, max_difficulty: 17 },
                { text: "a cunning cloaker, blending into the shadows of a cave", min_difficulty: 12, max_difficulty: 16 },
                { text: "a small group of veteran drow warriors, on a scouting mission", min_difficulty: 11, max_difficulty: 15 },
                { text: "a powerful flesh golem, animated by dark magic", min_difficulty: 14, max_difficulty: 18 },
                { text: "a swarm of aggressive rust monsters, attracted to metal", min_difficulty: 11, max_difficulty: 15 },
                { text: "a formidable adult white dragon, master of its icy domain", min_difficulty: 15, max_difficulty: 19 },
                { text: "a powerful storm giant, wielding lightning and thunder", min_difficulty: 16, max_difficulty: 20 },
                { text: "a demon prince's lieutenant, leading a small incursion", min_difficulty: 17, max_difficulty: 20 },
                { text: "a colossal purple worm, burrowing through the earth", min_difficulty: 18, max_difficulty: 20 },
                { text: "a powerful arch-mage, defending their tower with deadly spells", min_difficulty: 19, max_difficulty: 20 },
                { text: "a celestial champion, testing the party's resolve", min_difficulty: 17, max_difficulty: 20 },
                { text: "a mischievous imp, attempting to make a deal", min_difficulty: 1, max_difficulty: 2 },
                { text: "a territorial giant badger, protecting its burrow", min_difficulty: 2, max_difficulty: 3 },
                { text: "a small band of kenku, mimicking sounds to confuse", min_difficulty: 3, max_difficulty: 5 },
                { text: "a solitary giant lizard, basking in the sun", min_difficulty: 1, max_difficulty: 2 },
                { text: "a curious awakened animal, seeking companionship", min_difficulty: 1, max_difficulty: 3 },
                { text: "a few agitated giant spiders, defending their web", min_difficulty: 2, max_difficulty: 4 },
                { text: "a lost traveler, in need of assistance", min_difficulty: 1, max_difficulty: 1 },
                { text: "a single, weak ghast, emitting a foul stench", min_difficulty: 4, max_difficulty: 6 },
                { text: "a small group of cult acolytes, attempting a minor summoning", min_difficulty: 3, max_difficulty: 5 },
                { text: "a grumpy grung, defending its swamp territory", min_difficulty: 2, max_difficulty: 4 },
                { text: "a cunning doppelganger, impersonating a known NPC", min_difficulty: 8, max_difficulty: 12 },
                { text: "a territorial gorgon, turning trespassers to stone", min_difficulty: 9, max_difficulty: 13 },
                { text: "a powerful revenant, seeking vengeance on a specific target", min_difficulty: 10, max_difficulty: 14 },
                { text: "a group of well-organized bandits, ambushing a caravan", min_difficulty: 6, max_difficulty: 10 },
                { text: "a cunning hags coven, luring travelers into their lair", min_difficulty: 11, max_difficulty: 15 },
                { text: "a powerful stone giant, guarding an ancient artifact", min_difficulty: 12, max_difficulty: 16 },
                { text: "a hive of aggressive hook horrors, defending their cavern", min_difficulty: 10, max_difficulty: 14 },
                { text: "a group of desperate mercenaries, willing to do anything for coin", min_difficulty: 9, max_difficulty: 13 },
                { text: "a fierce young green dragon, defending its forest domain", min_difficulty: 13, max_difficulty: 17 },
                { text: "a powerful adult black dragon, master of its acidic swamp", min_difficulty: 16, max_difficulty: 20 },
                { text: "a cunning vampire lord, preying on the local populace", min_difficulty: 17, max_difficulty: 20 },
                { text: "a powerful death knight, leading an undead army", min_difficulty: 18, max_difficulty: 20 },
                { text: "a colossal tarrasque, rampaging across the land", min_difficulty: 20, max_difficulty: 20 },
                { text: "a powerful arch-fey, testing the party's loyalty", min_difficulty: 16, max_difficulty: 19 },
                { text: "a celestial avenger, seeking justice for a great wrong", min_difficulty: 15, max_difficulty: 18 },
                { text: "a full-fledged army of well-equipped githyanki, on an astral raid", min_difficulty: 17, max_difficulty: 20 },
                { text: "a powerful marilith demon, wielding multiple blades", min_difficulty: 18, max_difficulty: 20 },
                { text: "a cunning mind flayer colony, expanding its influence", min_difficulty: 19, max_difficulty: 20 },
                { text: "a playful pixie, leading the party astray with illusions", min_difficulty: 1, max_difficulty: 2 },
                { text: "a hungry giant badger, digging for roots", min_difficulty: 2, max_difficulty: 3 },
                { text: "a small band of goblins, bickering over loot", min_difficulty: 1, max_difficulty: 3 },
                { text: "a solitary giant constrictor snake, sunning itself", min_difficulty: 2, max_difficulty: 4 },
                { text: "a curious awakened plant, asking philosophical questions", min_difficulty: 1, max_difficulty: 2 },
                { text: "a few agitated giant wasps, defending their hive", min_difficulty: 3, max_difficulty: 5 },
                { text: "a lost merchant, robbed and left for dead", min_difficulty: 1, max_difficulty: 2 },
                { text: "a single, weak wight, guarding a forgotten grave", min_difficulty: 5, max_difficulty: 7 },
                { text: "a small group of cult fanatics, attempting to sacrifice a victim", min_difficulty: 4, max_difficulty: 6 },
                { text: "a grumpy kuo-toa, attempting to worship a new god", min_difficulty: 3, max_difficulty: 5 },
                { text: "a cunning yuan-ti pureblood, attempting to infiltrate a town", min_difficulty: 7, max_difficulty: 11 },
                { text: "a territorial gorgon, turning trespassers to stone with its gaze", min_difficulty: 9, max_difficulty: 13 },
                { text: "a powerful young silver dragon, guarding a mountain peak", min_difficulty: 14, max_difficulty: 18 },
                { text: "a small group of veteran drow priestesses, performing a dark ritual", min_difficulty: 13, max_difficulty: 17 },
                { text: "a powerful iron golem, animated by a mad wizard", min_difficulty: 15, max_difficulty: 19 },
                { text: "a swarm of aggressive otyughs, lurking in the sewers", min_difficulty: 12, max_difficulty: 16 },
                { text: "a formidable adult gold dragon, testing the party's worth", min_difficulty: 17, max_difficulty: 20 },
                { text: "a powerful storm giant, commanding a fleet of airships", min_difficulty: 16, max_difficulty: 20 },
                { text: "a demon lord's champion, leading a destructive rampage", min_difficulty: 19, max_difficulty: 20 },
                { text: "a colossal elder brain, controlling a vast network of mind flayers", min_difficulty: 20, max_difficulty: 20 },
                { text: "a powerful arch-demon, attempting to open a portal to the abyss", min_difficulty: 19, max_difficulty: 20 },
                { text: "a celestial general, leading a host of angels against evil", min_difficulty: 18, max_difficulty: 20 }
            ];

            const objectives = [
                { text: "find a lost child who wandered off", min_difficulty: 1, max_difficulty: 4 },
                { text: "deliver an urgent message to a nearby settlement", min_difficulty: 2, max_difficulty: 5 },
                { text: "clear a minor blockage from a well-used path", min_difficulty: 1, max_difficulty: 3 },
                { text: "gather rare medicinal herbs before nightfall", min_difficulty: 3, max_difficulty: 6 },
                { text: "rescue a captured villager from a small bandit camp", min_difficulty: 4, max_difficulty: 8 },
                { text: "escort a valuable but fragile cargo through dangerous territory", min_difficulty: 6, max_difficulty: 10 },
                { text: "recover stolen goods from a cunning group of thieves", min_difficulty: 5, max_difficulty: 9 },
                { text: "investigate strange disappearances in a remote area", min_difficulty: 7, max_difficulty: 11 },
                { text: "defeat a monstrous threat that has been terrorizing locals", min_difficulty: 9, max_difficulty: 13 },
                { text: "unravel a local mystery involving ancient prophecies", min_difficulty: 10, max_difficulty: 14 },
                { text: "survive a sudden, brutal ambush by elite foes", min_difficulty: 12, max_difficulty: 16 },
                { text: "stop a dark ritual before it summons an elder evil", min_difficulty: 15, max_difficulty: 19 },
                { text: "retrieve a legendary artifact from a heavily guarded vault", min_difficulty: 16, max_difficulty: 20 },
                { text: "negotiate a peace treaty between warring factions", min_difficulty: 8, max_difficulty: 12 },
                { text: "map an unexplored section of a vast cavern system", min_difficulty: 7, max_difficulty: 11 },
                { text: "disarm a magical ward protecting a cursed area", min_difficulty: 11, max_difficulty: 15 },
                { text: "find a cure for a spreading plague", min_difficulty: 13, max_difficulty: 17 },
                { text: "protect a vulnerable caravan from relentless attacks", min_difficulty: 9, max_difficulty: 14 },
                { text: "assassinate a corrupt noble protected by powerful magic", min_difficulty: 14, max_difficulty: 18 },
                { text: "close a planar rift before it engulfs the region", min_difficulty: 17, max_difficulty: 20 },
                { text: "retrieve a fragment of a shattered god's essence, hidden in a perilous realm", min_difficulty: 18, max_difficulty: 20 },
                { text: "sabotage a ritual that would unleash a planar invasion, threatening all life", min_difficulty: 16, max_difficulty: 19 },
                { text: "negotiate a fragile truce between two ancient, warring clans on the brink of war", min_difficulty: 9, max_difficulty: 13 },
                { text: "investigate the mysterious silence from a remote magical academy, fearing the worst", min_difficulty: 12, max_difficulty: 16 },
                { text: "recover a stolen royal heirloom from a heavily fortified stronghold, teeming with guards", min_difficulty: 10, max_difficulty: 14 },
                // --- NEW OBJECTIVES (100 new entries) ---
                { text: "help a farmer clear a field of overgrown weeds", min_difficulty: 1, max_difficulty: 2 },
                { text: "find a lost pet for a distraught child", min_difficulty: 1, max_difficulty: 3 },
                { text: "deliver a basket of goods to a secluded hermit", min_difficulty: 2, max_difficulty: 4 },
                { text: "investigate strange noises coming from a nearby cave", min_difficulty: 3, max_difficulty: 5 },
                { text: "assist a local guard patrol with a minor disturbance", min_difficulty: 2, max_difficulty: 3 },
                { text: "retrieve a forgotten tool from a dangerous construction site", min_difficulty: 1, max_difficulty: 2 },
                { text: "escort a group of pilgrims to a sacred shrine", min_difficulty: 3, max_difficulty: 6 },
                { text: "gather rare ingredients for a local alchemist", min_difficulty: 4, max_difficulty: 7 },
                { text: "clear a small bandit hideout disrupting trade routes", min_difficulty: 5, max_difficulty: 8 },
                { text: "investigate a series of petty thefts in a market district", min_difficulty: 4, max_difficulty: 6 },
                { text: "rescue a noble's child from a group of desperate kidnappers", min_difficulty: 7, max_difficulty: 11 },
                { text: "recover a stolen magical item from a cunning rogue guild", min_difficulty: 8, max_difficulty: 12 },
                { text: "stop a monstrous beast from terrorizing a remote village", min_difficulty: 9, max_difficulty: 13 },
                { text: "escort a diplomat through a war-torn region", min_difficulty: 10, max_difficulty: 14 },
                { text: "investigate a mysterious plague spreading through a city", min_difficulty: 11, max_difficulty: 15 },
                { text: "infiltrate a cult's hidden lair and disrupt their operations", min_difficulty: 12, max_difficulty: 16 },
                { text: "retrieve an ancient relic from a forgotten, trap-filled tomb", min_difficulty: 13, max_difficulty: 17 },
                { text: "defend a besieged fortress against a goblinoid horde", min_difficulty: 14, max_difficulty: 18 },
                { text: "assassinate a powerful crime lord controlling the city's underworld", min_difficulty: 15, max_difficulty: 19 },
                { text: "close a dangerous planar rift threatening to engulf the region", min_difficulty: 16, max_difficulty: 20 },
                { text: "seek an audience with an ancient dragon to gain its wisdom", min_difficulty: 17, max_difficulty: 20 },
                { text: "prevent a powerful demon from being summoned into the world", min_difficulty: 18, max_difficulty: 20 },
                { text: "retrieve a fragment of a shattered god's essence, hidden in a perilous realm", min_difficulty: 18, max_difficulty: 20 },
                { text: "sabotage a ritual that would unleash a planar invasion, threatening all life", min_difficulty: 16, max_difficulty: 19 },
                { text: "negotiate a fragile truce between two ancient, warring clans on the brink of war", min_difficulty: 9, max_difficulty: 13 },
                { text: "investigate the mysterious silence from a remote magical academy, fearing the worst", min_difficulty: 12, max_difficulty: 16 },
                { text: "recover a stolen royal heirloom from a heavily fortified stronghold, teeming with guards", min_difficulty: 10, max_difficulty: 14 },
                { text: "assist a cartographer in mapping a dangerous, unexplored forest", min_difficulty: 3, max_difficulty: 7 },
                { text: "find a rare flower that blooms only under a specific celestial event", min_difficulty: 5, max_difficulty: 9 },
                { text: "help a local lord uncover a conspiracy within his court", min_difficulty: 8, max_difficulty: 12 },
                { text: "clear a haunted house of its restless spirits", min_difficulty: 6, max_difficulty: 10 },
                { text: "protect a valuable trade caravan from monstrous attacks", min_difficulty: 9, max_difficulty: 13 },
                { text: "retrieve a sacred text from a forgotten, monster-infested library", min_difficulty: 11, max_difficulty: 15 },
                { text: "broker a peace treaty between warring factions in a distant land", min_difficulty: 14, max_difficulty: 18 },
                { text: "destroy a powerful magical artifact that is corrupting the land", min_difficulty: 16, max_difficulty: 20 },
                { text: "rescue a captured celestial being from a demonic prison", min_difficulty: 19, max_difficulty: 20 },
                { text: "find a hidden treasure map and follow it to its elusive end", min_difficulty: 4, max_difficulty: 8 },
                { text: "investigate strange magical anomalies occurring in a rural area", min_difficulty: 7, max_difficulty: 11 },
                { text: "recover stolen supplies from a well-fortified bandit stronghold", min_difficulty: 6, max_difficulty: 10 },
                { text: "help a desperate family escape a war-torn region", min_difficulty: 5, max_difficulty: 9 },
                { text: "uncover the truth behind a series of mysterious disappearances", min_difficulty: 8, max_difficulty: 12 },
                { text: "retrieve a rare ingredient from the lair of a dangerous beast", min_difficulty: 10, max_difficulty: 14 },
                { text: "defend a sacred grove from desecration by dark forces", min_difficulty: 12, max_difficulty: 16 },
                { text: "infiltrate an enemy camp to gather vital intelligence", min_difficulty: 13, max_difficulty: 17 },
                { text: "stop a powerful necromancer from raising an undead army", min_difficulty: 15, max_difficulty: 19 },
                { text: "perform a complex ritual to cleanse a corrupted land", min_difficulty: 17, max_difficulty: 20 },
                { text: "seek out a legendary weapon said to be able to defeat a great evil", min_difficulty: 18, max_difficulty: 20 },
                { text: "mediate a dispute between two powerful elemental lords", min_difficulty: 16, max_difficulty: 19 },
                { text: "rescue a group of trapped miners from a collapsing cave", min_difficulty: 3, max_difficulty: 7 },
                { text: "find a missing scholar who vanished while researching ancient ruins", min_difficulty: 5, max_difficulty: 9 },
                { text: "help a local community rebuild after a natural disaster", min_difficulty: 2, max_difficulty: 6 },
                { text: "investigate rumors of a monstrous creature lurking in the sewers", min_difficulty: 6, max_difficulty: 10 },
                { text: "retrieve a stolen idol from a goblin warren", min_difficulty: 4, max_difficulty: 8 },
                { text: "escort a valuable prisoner through hostile territory", min_difficulty: 7, max_difficulty: 11 },
                { text: "uncover a smuggling ring operating out of the city docks", min_difficulty: 8, max_difficulty: 12 },
                { text: "defeat a powerful construct guarding an ancient vault", min_difficulty: 11, max_difficulty: 15 },
                { text: "find a cure for a rare magical disease affecting a royal family", min_difficulty: 13, max_difficulty: 17 },
                { text: "prevent a powerful cult from awakening an ancient evil", min_difficulty: 15, max_difficulty: 19 },
                { text: "retrieve a powerful artifact from a demon lord's treasury", min_difficulty: 17, max_difficulty: 20 },
                { text: "seek the aid of a powerful celestial being to defeat a great evil", min_difficulty: 18, max_difficulty: 20 },
                { text: "negotiate a non-aggression pact between two rival dragon factions", min_difficulty: 19, max_difficulty: 20 },
                { text: "recover a lost spellbook from a wizard's tower infested with elementals", min_difficulty: 12, max_difficulty: 16 },
                { text: "assist a struggling village with a persistent pest problem", min_difficulty: 1, max_difficulty: 3 },
                { text: "find a specific rare bird for a collector", min_difficulty: 2, max_difficulty: 4 },
                { text: "deliver a message to a secluded druid circle", min_difficulty: 3, max_difficulty: 5 },
                { text: "investigate a series of strange animal attacks", min_difficulty: 4, max_difficulty: 6 },
                { text: "assist a group of scholars in exploring ancient ruins", min_difficulty: 5, max_difficulty: 9 },
                { text: "retrieve a stolen map from a group of wilderness bandits", min_difficulty: 6, max_difficulty: 10 },
                { text: "uncover a spy operating within the city guard", min_difficulty: 7, max_difficulty: 11 },
                { text: "defeat a powerful ghost haunting a local landmark", min_difficulty: 8, max_difficulty: 12 },
                { text: "find a legendary lost city rumored to hold great riches", min_difficulty: 10, max_difficulty: 14 },
                { text: "stop a powerful elemental from rampaging through the countryside", min_difficulty: 11, max_difficulty: 15 },
                { text: "rescue a group of captured adventurers from a drow outpost", min_difficulty: 13, max_difficulty: 17 },
                { text: "defend a magical ley line from being corrupted", min_difficulty: 14, max_difficulty: 18 },
                { text: "assassinate a tyrannical ruler causing widespread suffering", min_difficulty: 16, max_difficulty: 20 },
                { text: "prevent a cosmic entity from manifesting on the material plane", min_difficulty: 19, max_difficulty: 20 },
                { text: "find a hidden portal to the feywild and explore its wonders", min_difficulty: 9, max_difficulty: 13 },
                { text: "investigate a mysterious silence from a remote dwarven outpost", min_difficulty: 10, max_difficulty: 14 },
                { text: "recover a stolen artifact from an underwater ruin", min_difficulty: 12, max_difficulty: 16 },
                { text: "help a rebel group overthrow an oppressive regime", min_difficulty: 14, max_difficulty: 18 },
                { text: "uncover the secrets of an ancient, forgotten civilization", min_difficulty: 15, max_difficulty: 19 },
                { text: "retrieve a rare component from the elemental plane of air", min_difficulty: 17, max_difficulty: 20 },
                { text: "stop a powerful vampire lord from turning a city into their thralls", min_difficulty: 18, max_difficulty: 20 },
                { text: "seek out a legendary sage for guidance on a world-ending prophecy", min_difficulty: 19, max_difficulty: 20 },
                { text: "mediate a conflict between a dragon and a giant settlement", min_difficulty: 16, max_difficulty: 20 },
                { text: "recover a lost piece of a divine artifact before it falls into the wrong hands", min_difficulty: 17, max_difficulty: 20 },
                { text: "assist a local lord in putting down a minor rebellion", min_difficulty: 6, max_difficulty: 10 },
                { text: "find a specific type of rare gemstone for a jeweler", min_difficulty: 4, max_difficulty: 8 },
                { text: "deliver a coded message to a secret resistance cell", min_difficulty: 5, max_difficulty: 9 },
                { text: "investigate a series of strange magical disturbances", min_difficulty: 7, max_difficulty: 11 },
                { text: "assist a group of explorers in navigating a treacherous jungle", min_difficulty: 8, max_difficulty: 12 },
                { text: "retrieve a stolen magical seed from a corrupted druid", min_difficulty: 9, max_difficulty: 13 },
                { text: "uncover a hidden cult operating within a major city", min_difficulty: 11, max_difficulty: 15 },
                { text: "defeat a powerful demon possessing a local leader", min_difficulty: 13, max_difficulty: 17 },
                { text: "find a way to reverse a powerful curse affecting an entire region", min_difficulty: 15, max_difficulty: 19 },
                { text: "prevent a powerful entity from consuming a star", min_difficulty: 19, max_difficulty: 20 },
                { text: "seek out a legendary beast for a specific magical component", min_difficulty: 10, max_difficulty: 14 },
                { text: "investigate a mysterious disappearance of an entire expedition", min_difficulty: 12, max_difficulty: 16 },
                { text: "recover a stolen artifact from a githyanki raiding party", min_difficulty: 14, max_difficulty: 18 },
                { text: "help a celestial being regain its lost power", min_difficulty: 16, max_difficulty: 20 },
                { text: "uncover a plot to unleash a forgotten god", min_difficulty: 18, max_difficulty: 20 }
            ];

            const complications = [
                { text: "a sudden, light rain begins, making the ground slick", min_difficulty: 1, max_difficulty: 3 },
                { text: "resources are slightly limited, requiring careful management", min_difficulty: 2, max_difficulty: 5 },
                { text: "a minor obstacle blocks the direct path, requiring a detour", min_difficulty: 1, max_difficulty: 4 },
                { text: "a sudden, violent storm erupts, reducing visibility", min_difficulty: 4, max_difficulty: 8 },
                { text: "the ground is riddled with hidden, non-lethal traps", min_difficulty: 5, max_difficulty: 9 },
                { text: "an unexpected, neutral third party appears, complicating matters", min_difficulty: 6, max_difficulty: 10 },
                { text: "there's a strict, but manageable, time limit", min_difficulty: 7, max_difficulty: 11 },
                { text: "reinforcements arrive unexpectedly, but are few in number", min_difficulty: 8, max_difficulty: 12 },
                { text: "a difficult moral dilemma arises, with no easy answer", min_difficulty: 9, max_difficulty: 13 },
                { text: "the environment itself is mildly hostile (e.g., strong currents, thorny bushes)", min_difficulty: 10, max_difficulty: 14 },
                { text: "a powerful magical anomaly interferes, causing minor disruptions", min_difficulty: 11, max_difficulty: 15 },
                { text: "a trusted companion is injured and needs immediate attention", min_difficulty: 12, max_difficulty: 16 },
                { text: "the target is not what it seems, requiring a change of plans", min_difficulty: 13, max_difficulty: 17 },
                { text: "a powerful magical anomaly constantly drains power or causes debuffs", min_difficulty: 14, max_difficulty: 18 },
                { text: "a trusted companion betrays the group at a critical moment", min_difficulty: 15, max_difficulty: 19 },
                { text: "the environment is actively trying to kill them (e.g., collapsing cave, lava flow)", min_difficulty: 16, max_difficulty: 20 },
                { text: "a powerful entity intervenes, changing the rules of the encounter", min_difficulty: 17, max_difficulty: 20 },
                { text: "a contagious disease breaks out within the party or population", min_difficulty: 10, max_difficulty: 15 },
                { text: "a crucial item is lost or broken during the encounter", min_difficulty: 8, max_difficulty: 13 },
                { text: "the party is separated and must find each other", min_difficulty: 7, max_difficulty: 12 },
                { text: "an ancient curse activates, affecting all nearby", min_difficulty: 15, max_difficulty: 19 },
                { text: "a rival adventuring party arrives, seeking the same objective", min_difficulty: 9, max_difficulty: 14 },
                { text: "the environment itself is sentient and actively hostile, manipulating the terrain", min_difficulty: 18, max_difficulty: 20 },
                { text: "a powerful, unforeseen magical surge disables all enchantments and magical items temporarily", min_difficulty: 16, max_difficulty: 19 },
                { text: "the party is afflicted with a debilitating, creeping curse that saps their strength", min_difficulty: 13, max_difficulty: 17 },
                { text: "a sudden, localized anti-magic field appears intermittently, neutralizing magic users", min_difficulty: 11, max_difficulty: 15 },
                { text: "a crucial path collapses, forcing a dangerous alternative route through a monster-infested area", min_difficulty: 8, max_difficulty: 12 },
                // --- NEW COMPLICATIONS (100 new entries) ---
                { text: "a sudden, dense fog rolls in, reducing visibility", min_difficulty: 1, max_difficulty: 4 },
                { text: "a key piece of information is missing, requiring further investigation", min_difficulty: 2, max_difficulty: 5 },
                { text: "the path is blocked by a recent rockslide, requiring a detour or clearing", min_difficulty: 3, max_difficulty: 6 },
                { text: "a local NPC is uncooperative or suspicious of the party", min_difficulty: 2, max_difficulty: 4 },
                { text: "a minor but persistent magical interference causes harmless illusions", min_difficulty: 1, max_difficulty: 3 },
                { text: "the party is mistaken for another group, leading to initial hostility", min_difficulty: 4, max_difficulty: 7 },
                { text: "a valuable item is accidentally damaged and needs repair", min_difficulty: 5, max_difficulty: 8 },
                { text: "a non-combat encounter requires a specific skill check to resolve peacefully", min_difficulty: 3, max_difficulty: 6 },
                { text: "the weather turns unexpectedly severe (e.g., blizzard, heatwave)", min_difficulty: 6, max_difficulty: 10 },
                { text: "a secondary, unrelated threat emerges, requiring a choice of priorities", min_difficulty: 7, max_difficulty: 11 },
                { text: "the target of the objective is more powerful or numerous than anticipated", min_difficulty: 8, max_difficulty: 12 },
                { text: "a trusted informant provides misleading or incomplete information", min_difficulty: 9, max_difficulty: 13 },
                { text: "the environment is actively hindering movement (e.g., quicksand, thick mud)", min_difficulty: 10, max_difficulty: 14 },
                { text: "a powerful magical ward must be bypassed without triggering an alarm", min_difficulty: 11, max_difficulty: 15 },
                { text: "a member of the party is afflicted with a minor, but annoying, curse", min_difficulty: 12, max_difficulty: 16 },
                { text: "the objective is guarded by an unexpected, powerful magical trap", min_difficulty: 13, max_difficulty: 17 },
                { text: "a rival faction or group is also pursuing the same objective", min_difficulty: 14, max_difficulty: 18 },
                { text: "the environment is collapsing or changing rapidly, creating new hazards", min_difficulty: 15, max_difficulty: 19 },
                { text: "a powerful entity observes the party, influencing events subtly", min_difficulty: 16, max_difficulty: 20 },
                { text: "the party's reputation precedes them, for better or worse, affecting interactions", min_difficulty: 10, max_difficulty: 14 },
                { text: "a crucial resource (e.g., healing potions, spell components) is running low", min_difficulty: 8, max_difficulty: 12 },
                { text: "the terrain is treacherous and requires frequent skill checks to navigate safely", min_difficulty: 7, max_difficulty: 11 },
                { text: "a local authority figure is corrupt or actively working against the party", min_difficulty: 9, max_difficulty: 13 },
                { text: "the target of the objective is protected by a powerful, hidden guardian", min_difficulty: 11, max_difficulty: 15 },
                { text: "a powerful magical aura dampens all magical abilities in the area", min_difficulty: 14, max_difficulty: 18 },
                { text: "a member of the party develops a temporary, debilitating phobia", min_difficulty: 13, max_difficulty: 17 },
                { text: "the objective is a moral grey area, forcing difficult ethical choices", min_difficulty: 15, max_difficulty: 19 },
                { text: "the environment is alive and actively hostile, manipulating the terrain", min_difficulty: 18, max_difficulty: 20 },
                { text: "a powerful, unforeseen magical surge disables all enchantments and magical items temporarily", min_difficulty: 16, max_difficulty: 19 },
                { text: "the party is afflicted with a debilitating, creeping curse that saps their strength", min_difficulty: 13, max_difficulty: 17 },
                { text: "a sudden, localized anti-magic field appears intermittently, neutralizing magic users", min_difficulty: 11, max_difficulty: 15 },
                { text: "a crucial path collapses, forcing a dangerous alternative route through a monster-infested area", min_difficulty: 8, max_difficulty: 12 },
                { text: "a sudden, unexpected tremor causes minor structural damage", min_difficulty: 1, max_difficulty: 3 },
                { text: "a key witness is uncooperative or afraid to speak", min_difficulty: 2, max_difficulty: 5 },
                { text: "the party is being tracked by a persistent, but weak, enemy", min_difficulty: 3, max_difficulty: 6 },
                { text: "a local festival or event causes unexpected crowds and delays", min_difficulty: 2, max_difficulty: 4 },
                { text: "a minor magical item malfunctions at a critical moment", min_difficulty: 1, max_difficulty: 3 },
                { text: "the party accidentally triggers a harmless, but embarrassing, trap", min_difficulty: 4, max_difficulty: 7 },
                { text: "a valuable clue is hidden and requires a difficult puzzle to reveal", min_difficulty: 5, max_difficulty: 8 },
                { text: "a non-combat encounter involves a complex social interaction with multiple factions", min_difficulty: 3, max_difficulty: 6 },
                { text: "the weather turns extremely severe (e.g., blizzard, heatwave)", min_difficulty: 6, max_difficulty: 10 },
                { text: "a secondary objective emerges that conflicts with the primary one", min_difficulty: 7, max_difficulty: 11 },
                { text: "the enemy has unexpected allies or reinforcements", min_difficulty: 8, max_difficulty: 12 },
                { text: "a powerful illusion hides the true nature of the objective or threat", min_difficulty: 9, max_difficulty: 13 },
                { text: "the environment is filled with minor, irritating magical effects", min_difficulty: 10, max_difficulty: 14 },
                { text: "a powerful magical barrier must be deactivated through a complex ritual", min_difficulty: 11, max_difficulty: 15 },
                { text: "a member of the party is temporarily blinded or deafened", min_difficulty: 12, max_difficulty: 16 },
                { text: "the objective is a sentient being that resists being moved or captured", min_difficulty: 13, max_difficulty: 17 },
                { text: "a powerful magical aura causes exhaustion or fatigue", min_difficulty: 14, max_difficulty: 18 },
                { text: "a trusted ally is secretly working for the enemy", min_difficulty: 15, max_difficulty: 19 },
                { text: "the environment is actively hostile, with sentient plants or shifting terrain", min_difficulty: 16, max_difficulty: 20 },
                { text: "a powerful entity attempts to possess a party member", min_difficulty: 17, max_difficulty: 20 },
                { text: "a contagious magical disease spreads rapidly through the population", min_difficulty: 10, max_difficulty: 15 },
                { text: "a crucial map or guide is lost or destroyed", min_difficulty: 8, max_difficulty: 13 },
                { text: "the party is separated by a magical anomaly and must find a way back together", min_difficulty: 7, max_difficulty: 12 },
                { text: "an ancient prophecy activates, forcing the party into a difficult choice", min_difficulty: 15, max_difficulty: 19 },
                { text: "a powerful rival adventuring party attempts to steal the objective", min_difficulty: 9, max_difficulty: 14 },
                { text: "the environment is a living entity that reacts to the party's actions", min_difficulty: 18, max_difficulty: 20 },
                { text: "a powerful, unforeseen magical surge causes random wild magic effects", min_difficulty: 16, max_difficulty: 19 },
                { text: "the party is afflicted with a debilitating, creeping curse that drains their magic", min_difficulty: 13, max_difficulty: 17 },
                { text: "a sudden, localized anti-magic field appears intermittently, neutralizing all magic", min_difficulty: 11, max_difficulty: 15 },
                { text: "a crucial bridge collapses, forcing a dangerous river crossing", min_difficulty: 8, max_difficulty: 12 },
                { text: "a sudden, strong gust of wind makes ranged attacks difficult", min_difficulty: 1, max_difficulty: 2 },
                { text: "a key item is hidden behind a complex riddle or puzzle", min_difficulty: 2, max_difficulty: 4 },
                { text: "the party encounters a neutral monster that must be bypassed or appeased", min_difficulty: 3, max_difficulty: 5 },
                { text: "a local cult attempts to recruit the party into their ranks", min_difficulty: 2, max_difficulty: 3 },
                { text: "a minor magical item causes temporary confusion", min_difficulty: 1, max_difficulty: 2 },
                { text: "the party is caught in a minor local conflict (e.g., bar brawl, street riot)", min_difficulty: 4, max_difficulty: 6 },
                { text: "a valuable item is cursed and causes minor misfortunes", min_difficulty: 5, max_difficulty: 7 },
                { text: "a non-combat encounter involves convincing a powerful, stubborn NPC", min_difficulty: 3, max_difficulty: 5 },
                { text: "the weather causes extreme exhaustion (e.g., sweltering heat, biting cold)", min_difficulty: 6, max_difficulty: 9 },
                { text: "a secondary objective requires the party to choose between two evils", min_difficulty: 7, max_difficulty: 10 },
                { text: "the enemy has set up a series of cunning ambushes", min_difficulty: 8, max_difficulty: 11 },
                { text: "a powerful illusion makes the environment seem safe when it's not", min_difficulty: 9, max_difficulty: 12 },
                { text: "the environment is filled with minor, damaging magical effects", min_difficulty: 10, max_difficulty: 13 },
                { text: "a powerful magical barrier must be bypassed through a deadly trial", min_difficulty: 11, max_difficulty: 14 },
                { text: "a member of the party is temporarily charmed by an enemy", min_difficulty: 12, max_difficulty: 15 },
                { text: "the objective is a powerful artifact that corrupts those who touch it", min_difficulty: 13, max_difficulty: 16 },
                { text: "a powerful magical aura causes madness or paranoia", min_difficulty: 14, max_difficulty: 17 },
                { text: "a trusted ally is revealed to be a powerful enemy in disguise", min_difficulty: 15, max_difficulty: 18 },
                { text: "the environment is actively trying to separate the party members", min_difficulty: 16, max_difficulty: 19 },
                { text: "a powerful entity attempts to drain the party's life force", min_difficulty: 17, max_difficulty: 20 }
            ];

            const RECENT_HISTORY_SIZE = 5; // Number of past items to remember and avoid

            // Store last generated elements as arrays for more robust repetition avoidance
            let lastGenerated = {
                environment: [],
                creature: [],
                objective: [],
                complication: []
            };

            function getRandomElement(arr) {
                return arr[Math.floor(Math.random() * arr.length)];
            }

            /**
             * Calculates a difficulty rating from 1 to 20 based on player level and party size.
             * This formula aims to scale linearly, with higher levels and more party members
             * increasing the rating.
             * @param {number} playerLevel - The average level of the players (1-20).
             * @param {number} partySize - The number of players in the party (1-10).
             * @returns {number} The calculated difficulty rating (1-20).
             */
            function calculateDifficultyRating(playerLevel, partySize) {
                const minLevel = 1;
                const maxLevel = 20;
                const minPartySize = 1;
                const maxPartySize = 10;

                const rawScore = (playerLevel * 3) + (partySize * 1);
                const minRawScore = (minLevel * 3) + (minPartySize * 1);
                const maxRawScore = (maxLevel * 3) + (maxPartySize * 1);

                const normalizedScore = (rawScore - minRawScore) / (maxRawScore - minRawScore);
                const difficultyRating = Math.round(normalizedScore * 19) + 1;

                return Math.max(1, Math.min(20, difficultyRating));
            }

            /**
             * Selects a random encounter element from a given list that falls within the
             * calculated difficulty rating, avoiding recently used elements.
             * @param {Array<Object>} dataList - The list of encounter elements (e.g., environments).
             * @param {number} currentRating - The calculated difficulty rating (1-20).
             * @param {Array<string>} recentHistory - A list of recently used texts to exclude.
             * @returns {string} The text of a randomly selected element.
             */
            function selectDynamicElement(dataList, currentRating, recentHistory) {
                const suitableElements = dataList.filter(item =>
                    currentRating >= item.min_difficulty &&
                    currentRating <= item.max_difficulty &&
                    !recentHistory.includes(item.text) // Exclude recently used items
                );

                if (suitableElements.length > 0) {
                    return getRandomElement(suitableElements).text;
                } else {
                    // Fallback: If no suitable elements are available after exclusion,
                    // pick from all suitable elements (even if recently used) to ensure a result.
                    const allSuitable = dataList.filter(item =>
                        currentRating >= item.min_difficulty && currentRating <= item.max_difficulty
                    );
                    if (allSuitable.length > 0) {
                        return getRandomElement(allSuitable).text;
                    }
                    console.warn(`No suitable element found for rating ${currentRating} in list. Falling back to any element.`);
                    return getRandomElement(dataList).text; // Ultimate fallback
                }
            }

            // Main Generation Function for Encounter Generator
            function generateEncounter() {
                const playerLevel = parseInt(playerLevelInput.value);
                const partySize = parseInt(partySizeInput.value);

                // Input validation
                if (isNaN(playerLevel) || playerLevel < 1 || playerLevel > 20) {
                    showMessage("Please enter a valid Player Level between 1 and 20.");
                    return;
                }
                if (isNaN(partySize) || partySize < 1 || partySize > 10) {
                    showMessage("Please enter a valid Party Size between 1 and 10.");
                    return;
                }

                const currentDifficultyRating = calculateDifficultyRating(playerLevel, partySize);
                difficultyDisplay.innerHTML = `Calculated Difficulty Rating: <span class="text-blue-200">${currentDifficultyRating} / 20</span>`;

                // Generate elements, using the updated history
                const newEnvironment = selectDynamicElement(environments, currentDifficultyRating, lastGenerated.environment);
                const newCreature = selectDynamicElement(creatures, currentDifficultyRating, lastGenerated.creature);
                const newObjective = selectDynamicElement(objectives, currentDifficultyRating, lastGenerated.objective);
                const newComplication = selectDynamicElement(complications, currentDifficultyRating, lastGenerated.complication);

                environmentEl.textContent = newEnvironment;
                creatureEl.textContent = newCreature;
                objectiveEl.textContent = newObjective;
                complicationEl.textContent = newComplication;

                // Update last generated values (add new, remove oldest if history too long)
                function updateHistory(category, newItem) {
                    lastGenerated[category].push(newItem);
                    if (lastGenerated[category].length > RECENT_HISTORY_SIZE) {
                        lastGenerated[category].shift(); // Remove the oldest item
                    }
                }

                updateHistory('environment', newEnvironment);
                updateHistory('creature', newCreature);
                updateHistory('objective', newObjective);
                updateHistory('complication', newComplication);
            }

            // --- Event Listeners and Initializations ---

            // Stat Tracker Initializations
            loadData();
            renderPlayers();
            renderEnemies();

            // Player section event delegation
            playersContainer.addEventListener('input', (event) => {
                const target = event.target;
                const playerId = target.dataset.playerId;
                const field = target.dataset.field;
                if (playerId && field) {
                    let value = target.value;
                    if (target.type === 'number') {
                        value = parseInt(value, 10) || 0;
                    }
                    updatePlayer(playerId, field, value);
                }
            });

            // Event delegation for magic item inputs (name and description)
            playersContainer.addEventListener('input', (event) => {
                const target = event.target;
                if (target.classList.contains('magic-item-input')) {
                    const playerId = target.dataset.playerId;
                    const itemId = target.dataset.itemId;
                    const field = target.dataset.field;
                    const value = target.value;
                    updateMagicItem(playerId, itemId, field, value);
                }
            });


            playersContainer.addEventListener('click', (event) => {
                const target = event.target;
                if (target.classList.contains('remove-player-btn')) {
                    const playerId = target.dataset.playerId;
                    if (playerId) {
                        removePlayer(playerId);
                    }
                } else if (target.classList.contains('spell-slot-btn')) {
                    const playerId = target.dataset.playerId;
                    const level = target.dataset.level;
                    const action = target.dataset.action;
                    if (playerId && level && action) {
                        const player = appData.players.find(p => p.id === playerId);
                        if (player) {
                            if (action === 'increment') {
                                if (player.spellSlots[level].current < player.spellSlots[level].max) {
                                    player.spellSlots[level].current++;
                                }
                            } else if (action === 'decrement') {
                                if (player.spellSlots[level].current > 0) {
                                    player.spellSlots[level].current--;
                                }
                            }
                            saveData();
                            renderPlayers(); // Re-render to update the display
                        }
                    }
                } else if (target.classList.contains('add-magic-item-btn')) {
                    const playerId = target.dataset.playerId;
                    if (playerId) {
                        addMagicItem(playerId);
                    }
                } else if (target.classList.contains('remove-magic-item-btn')) {
                    const playerId = target.dataset.playerId;
                    const itemId = target.dataset.itemId;
                    if (playerId && itemId) {
                        removeMagicItem(playerId, itemId);
                    }
                }
            });

            addPlayerBtn.addEventListener('click', addPlayer);

            // Dice roller event listeners
            document.querySelectorAll('.dice-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const diceType = event.target.dataset.dice;
                    const result = rollDice(diceType);
                    diceResults.textContent = `Rolled ${diceType}: ${result}`;
                });
            });

            rollCustomBtn.addEventListener('click', () => {
                parseAndRollCustomDice(customDiceInput.value);
            });

            customDiceInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    parseAndRollCustomDice(customDiceInput.value);
                }
            });

            // Enemy section event delegation
            enemiesContainer.addEventListener('input', (event) => {
                const target = event.target;
                const enemyId = target.dataset.enemyId;
                const field = target.dataset.field;
                if (enemyId && field) {
                    let value = target.value;
                    if (target.type === 'number') {
                        value = parseInt(value, 10) || 0;
                    }
                    updateEnemy(enemyId, field, value);
                }
            });

            enemiesContainer.addEventListener('click', (event) => {
                const target = event.target;
                if (target.classList.contains('remove-enemy-btn')) {
                    const enemyId = target.dataset.enemyId;
                    if (enemyId) {
                        removeEnemy(enemyId);
                    }
                } else if (target.classList.contains('enemy-hp-btn')) {
                    const enemyId = target.dataset.enemyId;
                    const action = target.dataset.action;
                    if (enemyId && action) {
                        const enemy = appData.enemies.find(e => e.id === enemyId);
                        if (enemy) {
                            const hpInput = document.querySelector(`#enemy-${enemyId} input[data-field="hp"]`);
                            if (hpInput) {
                                let currentHp = parseInt(hpInput.value, 10);
                                if (action === 'increment') {
                                    currentHp++;
                                } else if (action === 'decrement') {
                                    currentHp--;
                                }
                                hpInput.value = currentHp;
                                updateEnemy(enemyId, 'hp', currentHp);
                            }
                        }
                    }
                }
            });

            addEnemyBtn.addEventListener('click', addEnemy);

            // Encounter Generator Initializations
            // Note: generateEncounter() is now called when 'encounter-view' is activated.
            // No need to call it on initial DOMContentLoaded.

            // Add event listeners to the button and input fields for Encounter Generator
            generateBtn.addEventListener('click', generateEncounter);
            playerLevelInput.addEventListener('input', generateEncounter);
            partySizeInput.addEventListener('input', generateEncounter);

            // Show the home view initially
            showView('home-view');
        });
    </script>
</body>
</html>
